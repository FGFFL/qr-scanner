<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>QR-Code Scanner mit Datum</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f2f2f2;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }

    header {
      background-color: #1e88e5;
      color: white;
      width: 100%;
      padding: 20px;
      text-align: center;
    }

    #container {
      background: white;
      padding: 20px;
      margin-top: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    #reader {
      width: 100%;
      max-width: 400px;
      margin: auto;
      position: relative;
    }

    #result {
      margin-top: 20px;
      font-size: 1.3em;
      font-weight: bold;
      text-align: center;
    }

    .valid { color: green; }
    .invalid { color: red; }
  </style>
</head>
<body>
  <header>
    <h1>QR-Code Scanner</h1>
    <p>Mit Datumsg√ºltigkeit</p>
  </header>

  <div id="container">
    <div id="reader"></div>
    <div id="result"></div>
  </div>

  <audio id="successSound" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg"></audio>
  <audio id="errorSound" src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg"></audio>

  <script>
    const resultEl = document.getElementById("result");
    const successSound = document.getElementById("successSound");
    const errorSound = document.getElementById("errorSound");

    let validCodes = [];
    let isScanningPaused = false;

    const today = new Date().toISOString().split("T")[0]; // z.‚ÄØB. "2025-03-27"

    fetch("valid-codes.json")
      .then(res => res.json())
      .then(data => {
        validCodes = data.codes;
      })
      .catch(() => {
        resultEl.innerHTML = `<p class="invalid">‚ö†Ô∏è Fehler beim Laden der g√ºltigen Codes</p>`;
      });

    function handleScan(qrCodeMessage) {
      if (isScanningPaused) return;
      isScanningPaused = true;

      const trimmed = qrCodeMessage.trim();
      const codeEntry = validCodes.find(entry => entry.code === trimmed);

      if (!codeEntry || (codeEntry.date && codeEntry.date !== today)) {
        resultEl.innerHTML = `<p class="invalid">‚ùå Nicht g√ºltig f√ºr heute (${today})</p>`;
        errorSound.play();
        document.body.style.backgroundColor = "#ffcdd2";
      } else {
        resultEl.innerHTML = `<p class="valid">‚úÖ G√ºltig: ${trimmed}</p>`;
        successSound.play();
        document.body.style.backgroundColor = "#c8e6c9";
      }

      setTimeout(() => {
        document.body.style.backgroundColor = "#f2f2f2";
        isScanningPaused = false;
      }, 2000);
    }

    function startScanner() {
      const html5QrCode = new Html5Qrcode("reader");
      Html5Qrcode.getCameras()
        .then(devices => {
          if (devices.length) {
            html5QrCode.start(
              devices[0].id,
              { fps: 10, qrbox: 250 },
              handleScan,
              () => {}
            );
          } else {
            resultEl.innerHTML = "<p class='invalid'>üö´ Keine Kamera gefunden</p>";
          }
        })
        .catch(() => {
          resultEl.innerHTML = "<p class='invalid'>üö´ Kamera-Zugriff verweigert</p>";
        });
    }

    startScanner();
  </script>
</body>
</html>
