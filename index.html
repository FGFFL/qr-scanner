<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>QR-Code Check-in</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    :root {
      --blue: #009DD4;
      --green: #76B828;
      --red: #D50C2F;
      --gray-bg: #f0f0f0;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: var(--gray-bg);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    header {
      width: 100%;
      background: var(--blue);
      color: white;
      padding: 20px;
      text-align: center;
    }

    main {
      background: white;
      width: 600px;
      margin: 40px auto;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      z-index: 1;
      position: relative;
    }

    #reader-wrapper {
      position: relative;
      width: 300px;
      height: 300px;
      margin: 0 auto;
      border: 4px solid var(--blue);
      border-radius: 10px;
      overflow: hidden;
      z-index: 1;
    }

    #reader {
      width: 100%;
      height: 100%;
    }

    #overlay-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 200px;
      height: 200px;
      transform: translate(-50%, -50%);
      border: 2px dashed limegreen;
      z-index: 5;
      pointer-events: none;
    }

    #result {
      margin-top: 20px;
      text-align: center;
      font-weight: bold;
      font-size: 1.2em;
    }

    .valid { color: var(--green); }
    .invalid { color: var(--red); }

    #controls {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
      position: relative;
      z-index: 2;
    }

    button {
      flex: 1;
      margin: 0 10px;
      padding: 12px;
      font-size: 1em;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      color: white;
      cursor: pointer;
    }

    #btnReset { background: var(--red); }
    #btnExport { background: var(--green); }

    #scanned {
      margin-top: 40px;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    li {
      background: #eee;
      padding: 8px 12px;
      margin-bottom: 6px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <header>
    <h1>QR-Code Check-in</h1>
    <p>Scannen Sie den Teilnehmer-Code</p>
  </header>

  <main>
    <section id="scanner">
      <div id="reader-wrapper">
        <div id="reader"></div>
        <div id="overlay-frame"></div>
      </div>
      <div id="result"></div>
    </section>

    <section id="controls">
      <button id="btnReset">Zurücksetzen</button>
      <button id="btnExport">Exportieren</button>
    </section>

    <section id="scanned">
      <h2>Gescannte Codes</h2>
      <ul id="codeList"></ul>
    </section>
  </main>

  <audio id="soundSuccess" src="success.mp3"></audio>
  <audio id="soundError" src="error.mp3"></audio>

  <script>
    const resultEl = document.getElementById("result");
    const codeListEl = document.getElementById("codeList");
    const successSound = document.getElementById("soundSuccess");
    const errorSound = document.getElementById("soundError");

    let scannedCodes = JSON.parse(localStorage.getItem("scannedCodes") || "[]");
    let validCodes = [];
    const today = new Date().toISOString().split("T")[0];

    function updateCodeList() {
      codeListEl.innerHTML = "";
      scannedCodes.forEach(item => {
        const li = document.createElement("li");
        li.textContent = `${item.code} – ${item.time}`;
        codeListEl.appendChild(li);
      });
    }

    function handleScan(qrMessage) {
      const trimmed = qrMessage.trim();
      const timestamp = new Date().toLocaleTimeString();
      const match = validCodes.find(c => c.code === trimmed);

      if (!match) {
        resultEl.innerHTML = `<span class="invalid">❌ Ungültig</span>`;
        errorSound.play();
      } else if (match.date && match.date !== today) {
        resultEl.innerHTML = `<span class="invalid">⏳ Nicht für heute</span>`;
        errorSound.play();
      } else if (scannedCodes.some(c => c.code === trimmed)) {
        resultEl.innerHTML = `<span class="invalid">⚠️ Bereits gescannt</span>`;
        errorSound.play();
      } else {
        scannedCodes.push({ code: trimmed, time: timestamp });
        localStorage.setItem("scannedCodes", JSON.stringify(scannedCodes));
        updateCodeList();
        resultEl.innerHTML = `<span class="valid">✅ Gültig</span>`;
        successSound.play();
      }
    }

    document.getElementById("btnReset").onclick = () => {
      if (confirm("Wirklich zurücksetzen?")) {
        scannedCodes = [];
        localStorage.removeItem("scannedCodes");
        updateCodeList();
        resultEl.innerHTML = "";
      }
    };

    document.getElementById("btnExport").onclick = () => {
      const csv = "Code,Zeit\n" + scannedCodes.map(c => `${c.code},${c.time}`).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "codes.csv";
      a.click();
      URL.revokeObjectURL(url);
    };

    function startScanner() {
      const html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 300, height: 300 } },
        handleScan
      ).catch(err => {
        resultEl.textContent = "Fehler beim Starten des Scanners.";
        console.error(err);
      });
    }

    fetch("valid-codes.json")
      .then(res => res.json())
      .then(data => {
        validCodes = data.codes;
        updateCodeList();
        startScanner();
      })
      .catch(() => {
        resultEl.textContent = "Fehler beim Laden der Codes.";
      });
  </script>
</body>
</html>
